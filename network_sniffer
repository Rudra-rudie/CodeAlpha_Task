from scapy.all import sniff, IP, TCP, UDP, ICMP, Raw
import datetime

def analyze_packet(pkt):
    print("\n=== New Packet Captured ===")
    print(f"Time: {datetime.datetime.now()}")

    # IP layer info
    if pkt.haslayer(IP):
        src_ip = pkt[IP].src
        dst_ip = pkt[IP].dst
        proto = pkt[IP].proto

        proto_name = {
            1: "ICMP",
            6: "TCP",
            17: "UDP"
        }.get(proto, f"Other ({proto})")

        print(f"Source IP      : {src_ip}")
        print(f"Destination IP : {dst_ip}")
        print(f"Protocol       : {proto_name}")

        # TCP info
        if pkt.haslayer(TCP):
            print(f"Source Port    : {pkt[TCP].sport}")
            print(f"Destination Port: {pkt[TCP].dport}")

        # UDP info
        elif pkt.haslayer(UDP):
            print(f"Source Port    : {pkt[UDP].sport}")
            print(f"Destination Port: {pkt[UDP].dport}")

        # ICMP info
        elif pkt.haslayer(ICMP):
            print("ICMP Packet Detected")

        # Payload
        if pkt.haslayer(Raw):
            payload = pkt[Raw].load
            try:
                print(f"Payload (text) : {payload.decode('utf-8', errors='replace')}")
            except:
                print("Payload (raw)  :", payload)

def start_sniffing(interface):
    print(f"Starting packet capture on {interface}...")
    sniff(iface=interface, prn=analyze_packet, store=False)

if __name__ == "__main__":
    # Replace with your network interface (e.g., "eth0", "wlan0", "ens33")
    interface = "ens33"
    try:
        start_sniffing(interface)
    except PermissionError:
        print("Permission denied. Please run this script as root/admin.")
    except Exception as e:
        print("Error:", e)
